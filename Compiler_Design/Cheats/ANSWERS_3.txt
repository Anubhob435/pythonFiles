/*******************************************************************************
 * LAB ASSIGNMENT - 3A
 * LEX and YACC Programs for Syntactic Analysis
 * 
 * Note: Each program typically consists of two files:
 * - .l file (LEX specification)
 * - .y file (YACC specification)
 * 
 * Compilation steps:
 * 1. lex filename.l
 * 2. yacc -d filename.y
 * 3. gcc lex.yy.c y.tab.c -o output -ll
 * 4. ./output
 ******************************************************************************/

/*******************************************************************************
 * PROGRAM 1: Count number of identifiers in a file
 * 
 * File: identifier_counter.l
 ******************************************************************************/

%{
#include <stdio.h>
int identifier_count = 0;
%}

/* Regular expression for identifier */
identifier [a-zA-Z_][a-zA-Z0-9_]*

/* C keywords that should not be counted as identifiers */
keyword (auto|break|case|char|const|continue|default|do|double|else|enum|extern|float|for|goto|if|int|long|register|return|short|signed|sizeof|static|struct|switch|typedef|union|unsigned|void|volatile|while)

%%

{keyword}       { /* Ignore keywords */ }
{identifier}    { 
                  printf("Identifier found: %s\n", yytext); 
                  identifier_count++; 
                }
.               { /* Ignore other characters */ }
\n              { /* Ignore newlines */ }

%%

int yywrap() {
    return 1;
}

int main(int argc, char *argv[]) {
    if (argc > 1) {
        FILE *file = fopen(argv[1], "r");
        if (!file) {
            printf("Cannot open file: %s\n", argv[1]);
            return 1;
        }
        yyin = file;
    }
    
    yylex();
    
    printf("\nTotal number of identifiers: %d\n", identifier_count);
    
    return 0;
}

/*
Sample Input (test.c):
int main() {
    int x = 10;
    int y = 20;
    int sum = x + y;
    return 0;
}

Sample Output:
Identifier found: main
Identifier found: x
Identifier found: y
Identifier found: sum
Identifier found: x
Identifier found: y

Total number of identifiers: 6
*/


/*******************************************************************************
 * PROGRAM 2: Test validity of arithmetic expression
 * 
 * File: expr_validity.l
 ******************************************************************************/

%{
#include "y.tab.h"
#include <stdlib.h>
%}

%%

[0-9]+          { yylval = atoi(yytext); return NUMBER; }
[ \t]           { /* Ignore whitespace */ }
\n              { return 0; }
.               { return yytext[0]; }

%%

int yywrap() {
    return 1;
}

/*
 * File: expr_validity.y
 */

%{
#include <stdio.h>
#include <stdlib.h>

void yyerror(const char *s);
int yylex(void);
%}

%token NUMBER

%%

expression: expr                { printf("Valid expression\n"); }
          ;

expr:     expr '+' term         { }
        | expr '-' term         { }
        | term                  { }
        ;

term:     term '*' factor       { }
        | term '/' factor       { }
        | factor                { }
        ;

factor:   NUMBER                { }
        | '(' expr ')'          { }
        ;

%%

void yyerror(const char *s) {
    printf("Invalid expression: %s\n", s);
}

int main() {
    printf("Enter an arithmetic expression: ");
    yyparse();
    return 0;
}

/*
Sample Output:
Enter an arithmetic expression: 10+20*30
Valid expression

Enter an arithmetic expression: 10++20
Invalid expression: syntax error
*/


/*******************************************************************************
 * PROGRAM 3: Recognize nested IF statements and display nesting level
 * 
 * File: nested_if.l
 ******************************************************************************/

%{
#include "y.tab.h"
%}

%%

"if"            { return IF; }
"else"          { return ELSE; }
"("             { return '('; }
")"             { return ')'; }
"{"             { return '{'; }
"}"             { return '}'; }
[a-zA-Z_][a-zA-Z0-9_]*  { return IDENTIFIER; }
[0-9]+          { return NUMBER; }
"=="            { return RELOP; }
"!="            { return RELOP; }
"<"             { return RELOP; }
">"             { return RELOP; }
"<="            { return RELOP; }
">="            { return RELOP; }
[ \t\n]         { /* Ignore whitespace */ }
.               { return yytext[0]; }

%%

int yywrap() {
    return 1;
}

/*
 * File: nested_if.y
 */

%{
#include <stdio.h>
#include <stdlib.h>

void yyerror(const char *s);
int yylex(void);

int nesting_level = 0;
int max_nesting = 0;
%}

%token IF ELSE IDENTIFIER NUMBER RELOP

%%

program: statement_list         { 
                                  printf("Maximum nesting level: %d\n", max_nesting); 
                                }
       ;

statement_list: statement
              | statement_list statement
              ;

statement: if_statement
         | expression_statement
         | compound_statement
         ;

if_statement: IF '(' condition ')' { 
                nesting_level++; 
                if (nesting_level > max_nesting) {
                    max_nesting = nesting_level;
                }
                printf("IF statement at nesting level: %d\n", nesting_level);
              } 
              statement { nesting_level--; }
            | IF '(' condition ')' { 
                nesting_level++; 
                if (nesting_level > max_nesting) {
                    max_nesting = nesting_level;
                }
                printf("IF statement at nesting level: %d\n", nesting_level);
              } 
              statement ELSE { 
                printf("ELSE at nesting level: %d\n", nesting_level);
              } 
              statement { nesting_level--; }
            ;

compound_statement: '{' statement_list '}'
                  | '{' '}'
                  ;

condition: IDENTIFIER RELOP IDENTIFIER
         | IDENTIFIER RELOP NUMBER
         | NUMBER RELOP IDENTIFIER
         | NUMBER RELOP NUMBER
         ;

expression_statement: IDENTIFIER ';'
                    | NUMBER ';'
                    ;

%%

void yyerror(const char *s) {
    fprintf(stderr, "Error: %s\n", s);
}

int main() {
    printf("Enter IF statements:\n");
    yyparse();
    return 0;
}

/*
Sample Input:
if (x > 10) {
    if (y < 5) {
        if (z == 3) {
            a;
        }
    }
}

Sample Output:
IF statement at nesting level: 1
IF statement at nesting level: 2
IF statement at nesting level: 3
Maximum nesting level: 3
*/


/*******************************************************************************
 * PROGRAM 4: Check syntax of arithmetic expression
 * 
 * File: syntax_check.l
 ******************************************************************************/

%{
#include "y.tab.h"
#include <stdlib.h>
%}

%%

[0-9]+          { yylval = atoi(yytext); return NUMBER; }
[a-zA-Z_][a-zA-Z0-9_]*  { return IDENTIFIER; }
[ \t]           { /* Ignore whitespace */ }
\n              { return 0; }
.               { return yytext[0]; }

%%

int yywrap() {
    return 1;
}

/*
 * File: syntax_check.y
 */

%{
#include <stdio.h>
#include <stdlib.h>

void yyerror(const char *s);
int yylex(void);
%}

%token NUMBER IDENTIFIER

%%

expression: expr                { printf("Syntax is correct!\n"); }
          ;

expr:     expr '+' term         { }
        | expr '-' term         { }
        | term                  { }
        ;

term:     term '*' factor       { }
        | term '/' factor       { }
        | factor                { }
        ;

factor:   NUMBER                { }
        | IDENTIFIER            { }
        | '(' expr ')'          { }
        ;

%%

void yyerror(const char *s) {
    printf("Syntax error: %s\n", s);
}

int main() {
    printf("Enter an expression to check syntax: ");
    yyparse();
    return 0;
}

/*
Sample Output:
Enter an expression to check syntax: a + b * c
Syntax is correct!

Enter an expression to check syntax: a + * b
Syntax error: syntax error
*/


/*******************************************************************************
 * PROGRAM 5: Evaluate arithmetic expression
 * 
 * File: evaluate_expr.l
 ******************************************************************************/

%{
#include "y.tab.h"
#include <stdlib.h>
%}

%%

[0-9]+          { yylval = atoi(yytext); return NUMBER; }
[ \t]           { /* Ignore whitespace */ }
\n              { return 0; }
.               { return yytext[0]; }

%%

int yywrap() {
    return 1;
}

/*
 * File: evaluate_expr.y
 */

%{
#include <stdio.h>
#include <stdlib.h>

void yyerror(const char *s);
int yylex(void);
%}

%token NUMBER
%left '+' '-'
%left '*' '/'

%%

expression: expr                { printf("Result: %d\n", $1); }
          ;

expr:     expr '+' expr         { $$ = $1 + $3; }
        | expr '-' expr         { $$ = $1 - $3; }
        | expr '*' expr         { $$ = $1 * $3; }
        | expr '/' expr         { 
                                  if ($3 == 0) {
                                      yyerror("Division by zero");
                                      $$ = 0;
                                  } else {
                                      $$ = $1 / $3;
                                  }
                                }
        | '(' expr ')'          { $$ = $2; }
        | NUMBER                { $$ = $1; }
        ;

%%

void yyerror(const char *s) {
    fprintf(stderr, "Error: %s\n", s);
}

int main() {
    printf("Enter an arithmetic expression: ");
    yyparse();
    return 0;
}

/*
Sample Output:
Enter an arithmetic expression: 10 + 20 * 3
Result: 70

Enter an arithmetic expression: (10 + 20) * 3
Result: 90

Enter an arithmetic expression: 100 / 5 - 10
Result: 10
*/


/*******************************************************************************
 * PROGRAM 6: Recognize valid variable names
 * 
 * File: valid_variable.l
 ******************************************************************************/

%{
#include "y.tab.h"
%}

%%

[a-zA-Z][a-zA-Z0-9]*    { return VARIABLE; }
[ \t\n]                 { /* Ignore whitespace */ }
.                       { return yytext[0]; }

%%

int yywrap() {
    return 1;
}

/*
 * File: valid_variable.y
 */

%{
#include <stdio.h>
#include <stdlib.h>

void yyerror(const char *s);
int yylex(void);
%}

%token VARIABLE

%%

input: VARIABLE         { printf("Valid variable name\n"); return 0; }
     ;

%%

void yyerror(const char *s) {
    printf("Invalid variable name\n");
}

int main() {
    printf("Enter a variable name: ");
    yyparse();
    return 0;
}

/*
Sample Output:
Enter a variable name: myVar123
Valid variable name

Enter a variable name: 123abc
Invalid variable name

Enter a variable name: _test
Invalid variable name
*/


/*******************************************************************************
 * PROGRAM 7: Recognize strings a^n b^n (n >= 0)
 * Grammar: S -> aSb | ab | a | epsilon
 * Accepts: "aaab", "abbb", "ab", "a"
 * 
 * File: anbm.l
 ******************************************************************************/

%{
#include "y.tab.h"
%}

%%

"a"             { return A; }
"b"             { return B; }
\n              { return 0; }
.               { return yytext[0]; }

%%

int yywrap() {
    return 1;
}

/*
 * File: anbm.y
 */

%{
#include <stdio.h>
#include <stdlib.h>

void yyerror(const char *s);
int yylex(void);
%}

%token A B

%%

/* Grammar for a^n b^m where n, m >= 0 */
S:    As Bs             { printf("String accepted!\n"); return 0; }
    | A                 { printf("String accepted!\n"); return 0; }
    |                   { printf("Empty string accepted!\n"); return 0; }
    ;

As:   A As
    | A
    ;

Bs:   B Bs
    | B
    ;

%%

void yyerror(const char *s) {
    printf("String not accepted\n");
}

int main() {
    printf("Enter string (combination of 'a' and 'b'): ");
    yyparse();
    return 0;
}

/*
Sample Output:
Enter string (combination of 'a' and 'b'): aaab
String accepted!

Enter string (combination of 'a' and 'b'): abbb
String accepted!

Enter string (combination of 'a' and 'b'): ab
String accepted!

Enter string (combination of 'a' and 'b'): a
String accepted!
*/


/*******************************************************************************
 * PROGRAM 8: Recognize grammar a^n b (n >= 10)
 * 
 * File: an_b.l
 ******************************************************************************/

%{
#include "y.tab.h"
%}

%%

"a"             { return A; }
"b"             { return B; }
\n              { return 0; }
.               { return yytext[0]; }

%%

int yywrap() {
    return 1;
}

/*
 * File: an_b.y
 */

%{
#include <stdio.h>
#include <stdlib.h>

void yyerror(const char *s);
int yylex(void);

int a_count = 0;
%}

%token A B

%%

/* Grammar for a^n b where n >= 10 */
S:    As B              { 
                          if (a_count >= 10) {
                              printf("String accepted! (a count: %d)\n", a_count);
                          } else {
                              printf("String rejected! Need at least 10 'a's (found %d)\n", a_count);
                          }
                          a_count = 0;
                          return 0;
                        }
    ;

As:   As A              { a_count++; }
    | A                 { a_count++; }
    ;

%%

void yyerror(const char *s) {
    printf("Invalid string format\n");
    a_count = 0;
}

int main() {
    printf("Enter string (at least 10 'a's followed by one 'b'): ");
    yyparse();
    return 0;
}

/*
Sample Output:
Enter string (at least 10 'a's followed by one 'b'): aaaaaaaaaab
String accepted! (a count: 10)

Enter string (at least 10 'a's followed by one 'b'): aaaaaab
String rejected! Need at least 10 'a's (found 6)

Enter string (at least 10 'a's followed by one 'b'): aaaaaaaaaaaaaaab
String accepted! (a count: 15)
*/


/*******************************************************************************
 * PROGRAM 9: Complete Calculator Implementation
 * 
 * File: calculator.l
 ******************************************************************************/

%{
#include "y.tab.h"
#include <stdlib.h>
#include <math.h>
%}

%%

[0-9]+\.?[0-9]*     { yylval.dval = atof(yytext); return NUMBER; }
"+"                 { return PLUS; }
"-"                 { return MINUS; }
"*"                 { return MULTIPLY; }
"/"                 { return DIVIDE; }
"^"                 { return POWER; }
"("                 { return LPAREN; }
")"                 { return RPAREN; }
"sin"               { return SIN; }
"cos"               { return COS; }
"tan"               { return TAN; }
"log"               { return LOG; }
"sqrt"              { return SQRT; }
[ \t]               { /* Ignore whitespace */ }
\n                  { return EOL; }
.                   { printf("Unexpected character: %c\n", yytext[0]); }

%%

int yywrap() {
    return 1;
}

/*
 * File: calculator.y
 */

%{
#include <stdio.h>
#include <stdlib.h>
#include <math.h>

void yyerror(const char *s);
int yylex(void);
%}

%union {
    double dval;
}

%token <dval> NUMBER
%token PLUS MINUS MULTIPLY DIVIDE POWER
%token LPAREN RPAREN
%token SIN COS TAN LOG SQRT
%token EOL

%type <dval> expr term factor

%left PLUS MINUS
%left MULTIPLY DIVIDE
%right POWER
%nonassoc UMINUS

%%

calclist: /* empty */
        | calclist expr EOL     { printf("= %.2f\n> ", $2); }
        | calclist EOL          { printf("> "); }
        ;

expr:     expr PLUS term        { $$ = $1 + $3; }
        | expr MINUS term       { $$ = $1 - $3; }
        | term                  { $$ = $1; }
        ;

term:     term MULTIPLY factor  { $$ = $1 * $3; }
        | term DIVIDE factor    { 
                                  if ($3 == 0) {
                                      yyerror("Division by zero");
                                      $$ = 0;
                                  } else {
                                      $$ = $1 / $3;
                                  }
                                }
        | factor                { $$ = $1; }
        ;

factor:   NUMBER                { $$ = $1; }
        | MINUS factor %prec UMINUS { $$ = -$2; }
        | factor POWER factor   { $$ = pow($1, $3); }
        | LPAREN expr RPAREN    { $$ = $2; }
        | SIN LPAREN expr RPAREN    { $$ = sin($3 * M_PI / 180); }
        | COS LPAREN expr RPAREN    { $$ = cos($3 * M_PI / 180); }
        | TAN LPAREN expr RPAREN    { $$ = tan($3 * M_PI / 180); }
        | LOG LPAREN expr RPAREN    { $$ = log10($3); }
        | SQRT LPAREN expr RPAREN   { $$ = sqrt($3); }
        ;

%%

void yyerror(const char *s) {
    fprintf(stderr, "Error: %s\n", s);
}

int main() {
    printf("Advanced Calculator\n");
    printf("Supported operations: +, -, *, /, ^\n");
    printf("Supported functions: sin, cos, tan, log, sqrt\n");
    printf("Enter expressions (Ctrl+C to exit):\n> ");
    yyparse();
    return 0;
}

/*
Sample Output:
Advanced Calculator
Supported operations: +, -, *, /, ^
Supported functions: sin, cos, tan, log, sqrt
Enter expressions (Ctrl+C to exit):
> 10 + 20 * 3
= 70.00
> (10 + 20) * 3
= 90.00
> 2 ^ 8
= 256.00
> sin(90)
= 1.00
> sqrt(16)
= 4.00
> log(100)
= 2.00
*/


/*******************************************************************************
 * ADDITIONAL PROGRAMS
 ******************************************************************************/

/*******************************************************************************
 * PROGRAM A: Recognize valid arithmetic expression
 * 
 * File: arith_expr.l
 ******************************************************************************/

%{
#include "y.tab.h"
%}

%%

[0-9]+              { return NUMBER; }
[a-zA-Z][a-zA-Z0-9]* { return IDENTIFIER; }
"+"                 { return '+'; }
"-"                 { return '-'; }
"*"                 { return '*'; }
"/"                 { return '/'; }
"("                 { return '('; }
")"                 { return ')'; }
[ \t\n]             { /* Ignore whitespace */ }
.                   { return yytext[0]; }

%%

int yywrap() {
    return 1;
}

/*
 * File: arith_expr.y
 */

%{
#include <stdio.h>
#include <stdlib.h>

void yyerror(const char *s);
int yylex(void);
%}

%token NUMBER IDENTIFIER

%%

program: expression     { printf("Valid arithmetic expression\n"); return 0; }
       ;

expression: expression '+' term
          | expression '-' term
          | term
          ;

term:     term '*' factor
        | term '/' factor
        | factor
        ;

factor:   NUMBER
        | IDENTIFIER
        | '(' expression ')'
        ;

%%

void yyerror(const char *s) {
    printf("Invalid arithmetic expression\n");
}

int main() {
    printf("Enter an arithmetic expression: ");
    yyparse();
    return 0;
}


/*******************************************************************************
 * PROGRAM B: Recognize valid variable
 * Already covered in Program 6
 ******************************************************************************/


/*******************************************************************************
 * PROGRAM C: Calculator using LEX and YACC
 * Already covered in Program 9
 ******************************************************************************/


/*******************************************************************************
 * COMPILATION INSTRUCTIONS
 * 
 * For any LEX + YACC program:
 * 
 * Step 1: Compile the LEX file
 *   $ lex filename.l
 * 
 * Step 2: Compile the YACC file
 *   $ yacc -d filename.y
 * 
 * Step 3: Compile both generated C files
 *   $ gcc lex.yy.c y.tab.c -o output -ll -lm
 *   
 *   Note: -ll links the LEX library
 *         -lm links the math library (for calculator)
 * 
 * Step 4: Run the program
 *   $ ./output
 * 
 * Alternative (using bison instead of yacc):
 *   $ flex filename.l
 *   $ bison -d filename.y
 *   $ gcc lex.yy.c filename.tab.c -o output -lfl -lm
 *   $ ./output
 ******************************************************************************/


/*******************************************************************************
 * END OF LAB ASSIGNMENT - 3A
 ******************************************************************************/
